---

- name: basic preflight duplicate checks
  block:
# source: https://www.reddit.com/r/ansible/comments/b5tzp1/ansible_get_list_of_subelements_and_assert_for/
    - name: create data structure to check via assertion
      set_fact:
        dupe_check: |
          {
            'reservation_count_total': {{ dhcp_reservations|length }},
            'reservation_mac_unique': {{ (dhcp_reservations | selectattr('mac', 'defined') | map(attribute='mac') | list) | unique | length }},
            'reservation_ip_unique': {{ (dhcp_reservations | selectattr('ip', 'defined') | map(attribute='ip') | list) | unique | length }},
            'reservation_hostname_unique': {{ (dhcp_reservations | selectattr('hostname', 'defined') | map(attribute='hostname') | list) | unique | length }}
          }

    - name: friendly neighbourhood debug output
      debug:
        var: dupe_check

    - name: assert no duplicates
      assert:
        that:
        - dupe_check.reservation_count_total == dupe_check.reservation_mac_unique
        - dupe_check.reservation_count_total == dupe_check.reservation_ip_unique
        - dupe_check.reservation_count_total == dupe_check.reservation_hostname_unique
  
  rescue:
    - name: Fail when errors
      ansible.builtin.debug:
        msg: 'Duplicate MAC, IP or hostname found. Running duplication checks.'

    - name: Create a list of all MAC addresses
      set_fact:
        list_macs: "{{ dhcp_reservations | selectattr('mac', 'defined') | map(attribute='mac') }}"

    - name: Create a list of all IP addresses
      set_fact:
        list_ips: "{{ dhcp_reservations | selectattr('ip', 'defined') | map(attribute='ip') }}"

    - name: Create a list of all hostnames
      set_fact:
        list_hostnames: "{{ dhcp_reservations | selectattr('hostname', 'defined') | map(attribute='hostname') }}"

    - name: dupe check
      debug:
        msg: "Duplicate entry: {{ item | duplicates }}"
      loop:
        - "{{ list_macs }}"
        - "{{ list_ips }}"
        - "{{ list_hostnames }}"

    - name: Fail when errors
      ansible.builtin.fail:
        msg: 'Duplicate MAC, IP or hostname found. Go to fail!'
